# Middleware

미들웨어라는 개념은 애플리케이션이 마치 여러 층을 가진 케이크나 양파처럼 일련의 계층으로 감싸져 있다는 것을 의미한다.

모든 요청은 애플리케이션으로 가는 과정에서 모든 미들웨어 계층을 통과한다.

그리고 응답이 최종 사용자에게 되돌아가는 길에 다시 미들웨어 레이어를 통과한다.

미들웨어의 가장 강력한 기능은 미들웨어가 요청/응답 사이클의 거의 처음과 마지막에 필요한 작업을 처리할 수 있다는 점이다.

이는 세션의 활성화 같은 작업을 처리하기에 딱 알맞은 경우다.

PHP에서는 요청/응답 사이클의 처음 부분에서 세션을 시작하고, 마지막 부분에서 세션을 닫아야 하는데 미들웨어가 이런 작업을 처리하기에는 최적의 장소다.

# 미들웨어의 handle() 메서드

우선 미들웨어는 다른 미들웨어 위에 하나씩 겹쳐지는 계층 구조를 갖고, 최종적으로 애플리케이션의 주요 비즈니스 로직을 둘러싸고 있다는 것을 기억하자.

요청이 들어오면 첫 번째 미들웨어에서 처리된 후 다른 미들웨어로 차례로 넘긴 다음에 주요 비즈니스 로직에 전달된다.

그 후 결과로 반환되는 응답은 요청이 처리될 때의 미들웨어의 반대 방향으로 통과하여 전달되고, 최종적으로 첫 번째 미들웨어가 마지막으로 응답을 처리한다.

$next()가 반환하는 것은 응답이고, $request가 미들웨어 스택을 따라 내려가 주요 로직에 전달된 다음 반환된 응답이 다시 미들웨어 스택을 거쳐온다.

$response = $next($request);

이 시점에 사용자에게 반환되기 직전인 응답에 다시 한번 추가적인 작업을 처리할 수 있다.

$response->cookie('visited-our-site', true);

마지막으로 최종 사용자에게 응답을 보낸다.

return $response

# 글로벌 미들웨어 등록

미들웨어 등록은 모두 app/http/kernel.php에서 이뤄진다. 미들웨어를 글로벌로 등록하려면

protected $middleware = ['middleware위치'];

# 라우트 미들웨어 등록

$routeMiddleware 배열에 추가





