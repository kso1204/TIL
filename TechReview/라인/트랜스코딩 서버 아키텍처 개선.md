# 트랜스코딩 서버 아키텍처 개선기

1. https://engineering.linecorp.com/ko/blog/line-transcoding-server-architecture-improvement-1/

- 본 글은 위 링크를 읽고, 해당 내용을 정리해본 글이다.

# 들어가며

1. 우리는 생활 속에서 다양한 방식으로 동영상을 생산하고 소비한다.

2. 자신의 스마트 폰으로 직접 동영상을 촬영하기도 하고, 누군가가 메신저로 공유해 준 동영상을 감상하기도 하고, 인터넷에 공개된 동영상을 다운로드 하기도 한다.

3. 그런데 이렇게 다양한 곳에서 다양한 방식으로 얻은 동영상이 간혹 재생되지 않는 경우가 발생한다.

4. 여러가지 이유가 있을 수 있지만, 대부분 스마트폰의 코덱이나 성능의 제약이 문제가 된다.

5. LINE에서는 이런 문제를 어떻게 해결하고 있을까?

6. LINE 트랜스코딩 서버에서는 모든 LINE 사용자가 문제없이 동영상을 시청할 수 있도록 가장 범용적인 포맷으로 동영상을 변환하고 있다.

7. 또한 더 적은 데이터 요금으로 동영상을 즐길 수 있고, 인터넷 환경이 좋지 않은 곳에서도 잘 재생될 수 있도록 동영상 품질을 최적화하고 있다.

8. 그 외에도 동영상이 필요한 LINE의 여러 서비스에 다양한 기능들을 제공하고 있는데, 이번 글에서 전 세계의 LINE 사용자가 발생시킨 동영상 트래픽을 처리하고 있는 LINE 트랜스코딩 서버의 아키텍처에 대해 이야기 해보겠다.

# 일반적인 동영상 트랜스코딩 과정

1. 동영상 트랜스코딩은 원본 동영상 파일을 다른 포맷의 동영상 파일로 변환하는 과정을 의미한다.

- PMP(Portable Media Player)처럼 휴대용 기기에서 사용할 수 있는 동영상 코덱이 제한적이었기 때문에, 컴퓨터에 저장된 동영상을 PMP에서 재생하기 위해서 제작사가 제공한 변환 프로그램을 거쳐야만 재생할 수 있었다.

2. 그림에서 모래시계는 과정별로 어느 정도의 시간이 소요되는지를 표시했다.

- Original File(.avi) -> Demuxer -> Video Decoder, Audio Decoder -> Video Encoder, Audio Encoder -> Muxer -> Output File(.mp4)

3. 비디오를 처리하는 데 다른 과정에 비해 많은 시간이 소요된다.

- 해상도가 높거나, 재생길이가 길거나, 초당 프레임 수가 많다면 더욱 많은 시간이 필요하다.

- 실제로 서버에서, 1280 * 780 픽셀, 길이 90초 정도 초당 프레임 수가 30인 동영상을 단일 GPU에서 트랜스코딩하면 '비디오 디코딩 + 비디오 인코딩'에 약 3분 40초, '오디오 디코딩 + 오디오 인코딩'엔 약 2.5초가 소요된다.

# LINE 트랜스코딩 서버 소개

1. LINE 트랜스코딩 서버는 LINE의 모든 서비스에 동영상 트랜스코딩과 동영상 프로세싱 기능을 제공하기 위한 서버플랫폼이다.

2. 2019년 12월 평일을 기준으로 하루에 약 2천만 건 이상의 동영상을 처리하고 있다.

3. LINE 트랜스코딩 서버를 리코더라는 명칭으로 설명한다.

# 리코더가 제공하는 기능

1. 리코더는 비디오의 품질을 결정하는 여러 가지 옵션을 제공하며, 생성된 비디오를 MP4(https://en.wikipedia.org/wiki/MPEG-4_Part_14)나 HLS(https://en.wikipedia.org/wiki/HTTP_Live_Streaming) 포맷으로 제공한다.

# 점진적 다운로드(Progressive Downloadable) MP4

1. 리코더에서 동영상을 MP4 포맷으로 트랜스코딩할 경우, 점진적 다운로드가 가능한 MP4 파일을 생성한다.

2. 점직전 다운로드를 설명하기에 앞서 일반적인 MP4 파일의 구조를 설명하겠다.

3. 우리가 일반적으로 부르는 MP4는 ISOBMFF(https://en.wikipedia.org/wiki/ISO/IEC_base_media_file_format) 파일 구조에 기반하고 있다.

4. ISOBMFF 파일 구조는 'box'라고 불리는 구조체로 구성되어 있는데, 여기에 미디어의 트랙 정보나 비디오 또는 오디오 데이터를 저장할 수 있다.

5. MP4 파일은 미디어의 메타데이터를 저장하고 있는 'moov box'와 실제 인코딩된 데이터를 저장하고 있는 'mdat box'로 구성되어 있다.

6. 이 때 메타데이터를 저장하기 위해 필요한 정보는 인코딩이 끝난 후에야 계산할 수 있기 때문에, moov box는 mdat box 다음에 위치하게 된다.

7. 점진적 다운로드 MP4를 설명해보자.

8. 동영상 플레이어에서 MP4 파일을 재생하기 위해서는, 먼저 동영상 파일의 메타데이터를 찾은 후에 인코딩된 오디오와 비디오의 데이터를 읽어 디코딩하는 과정을 수행해야 한다.

9. 따라서 동영상 플레이어는 moov box에 저장된 메타데이터를 찾아 mdat box에 저장되어 있는 오디오 데이터의 시작 위치나 비디오 데이터의 시작 위치를 알아낸뒤,

10. mdat box에 저장된 데이터를 읽어 디코딩 과정을 거쳐 화면에 비디오를 출력하거나 스피커를 통해 음성을 출력한다.

11. 그런데 만약 스트리밍 서비스를 통해 MP4 파일을 재생하는 경우라면 어떨까?

12. 동영상을 재생하기 위해서는 먼저 moov box를 찾아야 한다.

13. 그런데 동영상 플레이어는 동영상 파일의 어느 위치에 moov box가 있는지 알 수 없으므로 moov box가 발견될 때까지 파일을 다운로드 하게 된다.

14. 아마 전체 동영상 파일을 다운로드 한 후에야 moov box를 찾을 수 있을 테고, 그 후 위에서 설명한 과정을 거친 뒤 동영상 파일을 재생할 수 있을 것이다.

15. 이렇게 되면 동영상의 일부분만 보고 싶더라도 전체 동영상 파일을 다운로드해야 하기 때문에 스트리밍 서비스에서 이런 MP4 파일을 재생하는 것은 비효율적이다.

16. 그래서 MP4 파일 전체를 다운로드하지 않더라도 재생할 수 있도록 만든 것이 바로 '점진적 다운로드 MP4'파일이다.

17. 아래 그림은 일반적인 MP4 파일의 구조와 점진적 다운로드 MP4 파일의 구조다.

```

General MP4

ftyp(File Type Box), mdat(Media Data Box), ... , moov(Movie Box)

Progressive MP4

ftyp(File Type Box), moov(Movie Box), mdat(Media Data Box), ...

```

18. 기존의 MP4 구조와 비교해 달라진 점은, moov box를 동영상 파일의 앞부분으로 이동했다는 점이다.

19. 그리고 moov box의 위치를 이동하면서 moov box에 저장되어 있는 오디오 데이터의 시작 위치, 비디오 데이터의 시작 위치를 변경해 준다.

20. 이렇게 moov box의 위치를 변경하게 되면 파일의 처음 일부분을 읽어 동영상 파일을 재생할 수 있게 된다.

21. 스트리밍 서비스의 경우 동영상 파일 전체를 다운로드하지 않아도 재생을 시작할 수 있고, 또한 탐색(Seek) 기능을 사용할 수 있어 사용자가 원하는 위치에서 영상을 시청할 수 있다는 장점이 있다.

22. 이러한 이유로 리코더는 사용자에게 점진적 다운로드가 가능한 MP4 파일을 제공하고 있다.

# HLS(Http Live-Streaming)

1. 리코더는 동영상이 중심이 되는 서비스에서 많이 사용하는 HLS 파일 포맷을 지원한다.

2. HLS에서는 ABR(https://en.wikipedia.org/wiki/Adaptive_bitrate_streaming)(Adaptive Bit Rate) 기능을 제공하고 있어서 다양한 네트워크 환경이나 단말에서 최적의 화질로 비디오를 제공할 수 있다.

3. 또한 저작권 등의 이유로 콘텐츠를 보호할 필요가 있는 서비스를 위해서 암호화 기능도 지원한다.

# 대표 장면 추출

1. 동영상 파일에서 원하는 위치의 프레임을 단일 이미지 파일로 추출하는 기능을 제공한다.

2. 복수의 이미지로 추출하는 기능도 같이 제공한다.

3. 특정 주기마다 이미지를 추출하는 방식과, 원하는 수만큼 추출하는 기능을 제공한다.

4. 최근에는 동영상의 특정 위치에 해당하는 프레임을 이미지로 추출할 때 검은색 이미지나 의미 없는 이미지가 추출되는 것을 피하고자,

5. 원본 동영상에서 의미가 있는 부분을 찾아 이미지 파일로 추출하는 기능을 제공하고 있다.